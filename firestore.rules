rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Users collection
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isAuthenticated() && request.auth.uid == userId;
      allow delete: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // Players collection
    match /players/{playerId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
    }
    
    // Teams collection
    match /teams/{teamId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
      
      // Teams players subcollection
      match /players/{playerId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }
    }
    
    // Tournaments collection
    match /tournaments/{tournamentId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
      
      // Tournament teams subcollection
      match /teams/{teamId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }
      
      // Tournament matches subcollection
      match /matches/{matchId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }
    }
    
    // Player Stats collection
    match /playerStats/{playerId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Matches collection
    match /matches/{matchId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && 
        (request.auth.uid == resource.data.createdBy || 
         request.auth.uid in resource.data.scorers);
      allow delete: if isAuthenticated() && request.auth.uid == resource.data.createdBy;
      
      // Innings subcollection - allow authenticated users to write
      match /innings/{inningsNumber} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }
      
      // Batting subcollection - allow authenticated users to write
      match /batting/{playerId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }
      
      // Bowling subcollection - allow authenticated users to write
      match /bowling/{playerId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }
      
      // Fall of wickets subcollection - allow authenticated users to write
      match /fallOfWickets/{wicketNumber} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }
      
      // Squads subcollection - allow authenticated users to write
      match /squads/{team} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }
      
      // Balls subcollection - allow authenticated users to write
      match /balls/{ballId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }
    }
  }
}
